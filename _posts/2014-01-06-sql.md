--- layout: post title:
"多种sql技术的综合应用（行转列、定制、批量数据产生）" date:
'2014-01-06T17:23:00.002+08:00' author: Wenh Q tags: modified\_time:
'2014-01-06T17:23:22.126+08:00' blogger\_id:
tag:blogger.com,1999:blog-4961947611491238191.post-622168169161913767
blogger\_orig\_url: http://binaryware.blogspot.com/2014/01/sql.html ---
<div dir="ltr">

[多种sql技术的综合应用（行转列、定制、批量数据产生）](http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html)  <span
style="font-family: sans-serif;">于 10-1-25 通过
</span>[博客园-首页原创精华区](http://www.cnblogs.com/)<span
style="font-family: sans-serif;"> 作者：王召冠</span>\
<div class="gmail_quote">

<div class="HOEnZb">

<div class="h5">

<div dir="ltr">

<div class="gmail_quote">

<div
style="font-family: sans-serif; margin: 0px 10px; overflow: auto; width: 100%;">

\
阅读: 692 评论: 0 作者: [王召冠](http://www.cnblogs.com/zhaoguan_wang/)
发表于 2010-01-25 20:34
[原文链接](http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html)\
<div>

<div>

<span style="color: teal;">/\*</span><span style="color: teal;">\
功能：按报表格式显示（行转列、定制、批量数据产生）\
作者：王召冠\
时间：2010-01-25 20:10\
说明：此例子也是多种sql技术的综合应用\
\
问题：假设有张考勤表(tb)如下:\
姓名    　考勤日期    　　考勤次数\
张三    2010-01-01        2\
张三    2010-01-02        3\
张三    2010-01-03        1\
张三    2010-01-01        1\
李四    2010-01-02        2\
李四    2010-01-03        2\
\
想变成(得到如下结果)：按指定时间段显示考勤报表\
姓名  2010-01-01 2010-01-02 2010-01-03 2010-01-04  ... 汇总    \
---- ---------- ---------- ---------- ----------      ----\
李四        0           2          2          0        4\
张三        3           3          1          0        7\
汇总        3           5          3          0        11\
----------------------------------------------------------</span><span
style="color: teal;">\*/</span>\
<span style="color: blue;">CREATE</span> <span
style="color: blue;">TABLE</span> tb(vName <span
style="color: blue;">NVARCHAR</span>(<span
style="color: maroon; font-weight: bold;">10</span>), dtDate <span
style="color: blue;">DATETIME</span>, iNum <span
style="color: blue;">INT</span>)\
<span style="color: blue;">GO</span>\
<span style="color: blue;">INSERT</span>  <span
style="color: blue;">INTO</span> tb <span
style="color: blue;">VALUES</span>  ( <span
style="color: red;">'</span><span style="color: red;">张三</span><span
style="color: red;">'</span>, <span style="color: red;">'</span><span
style="color: red;">2010-01-01</span><span
style="color: red;">'</span>, <span
style="color: maroon; font-weight: bold;">2</span> )\
<span style="color: blue;">INSERT</span>  <span
style="color: blue;">INTO</span> tb<span
style="color: blue;">VALUES</span>  ( <span
style="color: red;">'</span><span style="color: red;">张三</span><span
style="color: red;">'</span>, <span style="color: red;">'</span><span
style="color: red;">2010-01-02</span><span
style="color: red;">'</span>, <span
style="color: maroon; font-weight: bold;">3</span> )\
<span style="color: blue;">INSERT</span>  <span
style="color: blue;">INTO</span> tb<span
style="color: blue;">VALUES</span>  ( <span
style="color: red;">'</span><span style="color: red;">张三</span><span
style="color: red;">'</span>, <span style="color: red;">'</span><span
style="color: red;">2010-01-03</span><span
style="color: red;">'</span>, <span
style="color: maroon; font-weight: bold;">1</span> )\
<span style="color: blue;">INSERT</span>  <span
style="color: blue;">INTO</span> tb<span
style="color: blue;">VALUES</span>  ( <span
style="color: red;">'</span><span style="color: red;">张三</span><span
style="color: red;">'</span>, <span style="color: red;">'</span><span
style="color: red;">2010-01-01</span><span
style="color: red;">'</span>, <span
style="color: maroon; font-weight: bold;">1</span> )\
<span style="color: blue;">INSERT</span>  <span
style="color: blue;">INTO</span> tb<span
style="color: blue;">VALUES</span>  ( <span
style="color: red;">'</span><span style="color: red;">李四</span><span
style="color: red;">'</span>, <span style="color: red;">'</span><span
style="color: red;">2010-01-02</span><span
style="color: red;">'</span>, <span
style="color: maroon; font-weight: bold;">2</span> )\
<span style="color: blue;">INSERT</span>  <span
style="color: blue;">INTO</span> tb<span
style="color: blue;">VALUES</span>  ( <span
style="color: red;">'</span><span style="color: red;">李四</span><span
style="color: red;">'</span>, <span style="color: red;">'</span><span
style="color: red;">2010-01-03</span><span
style="color: red;">'</span>, <span
style="color: maroon; font-weight: bold;">2</span> )\
<span style="color: blue;">GO</span>\
<span style="color: teal;">--</span><span
style="color: teal;">SELECT    \*</span><span style="color: teal;">\
--</span><span style="color: teal;">FROM    tb</span><span
style="color: teal;">\
</span>    <span style="color: teal;">--</span><span
style="color: teal;">SQL SERVER 动态SQL</span><span
style="color: teal;">\
</span><span
style="color: teal;">DECLARE @dtBegin DATETIME, @dtEnd DATETIME</span><span
style="color: teal;">\
</span><span
style="color: teal;">SELECT    @dtBegin = '2010-01-01', @dtEnd = '2010-01-31'</span><span
style="color: teal;">\
</span>\
<span style="color: blue;">SET</span> NOCOUNT <span
style="color: blue;">ON</span>\
<span style="color: teal;">/\*</span><span style="color: teal;">\
此处代码功能说明：\
    根据指定的时间段，快速生成一个不间断的时间序列表\
具体实现特性说明：\
    每循环一次生成2的n次方条记录，减少循环次数。\
注：\
    从实际应用上来说，在此处没有太明显的效果和意义；仅仅体现一种优化算法而已。\
</span><span style="color: teal;">\*/</span>\
<span style="color: blue;">DECLARE</span> <span
style="color: green;">@iRank</span> <span
style="color: blue;">INT</span> <span
style="color: blue;">SET</span> <span
style="color: green;">@iRank</span> <span
style="color: grey;">=</span> <span
style="color: maroon; font-weight: bold;">1</span>\
<span style="color: blue;">DECLARE</span> <span
style="color: green;">@tmp</span> <span
style="color: blue;">TABLE</span>(dtDate <span
style="color: blue;">DATETIME</span>)\
<span style="color: blue;">INSERT</span> <span
style="color: blue;">INTO</span> <span
style="color: green;">@tmp</span> ( dtDate ) <span
style="color: blue;">VALUES</span> ( <span
style="color: green;">@dtBegin</span> )\
<span style="color: blue;">WHILE</span> <span
style="color: magenta;">DATEADD</span>(<span
style="color: magenta;">DAY</span>, <span
style="color: magenta;">POWER</span>(<span
style="color: maroon; font-weight: bold;">2</span>, (<span
style="color: green;">@iRank</span><span
style="color: grey;">-</span><span
style="color: maroon; font-weight: bold;">1</span>)), <span
style="color: green;">@dtBegin</span>) <span
style="color: grey;">&lt;=</span> <span
style="color: green;">@dtEnd</span>\
<span style="color: blue;">BEGIN</span>\
    <span style="color: blue;">INSERT</span> <span
style="color: blue;">INTO</span> <span
style="color: green;">@tmp</span> ( dtDate )\
    <span style="color: blue;">SELECT</span>    <span
style="color: magenta;">DATEADD</span>(<span
style="color: magenta;">DAY</span>, <span
style="color: magenta;">POWER</span>(<span
style="color: maroon; font-weight: bold;">2</span>, (<span
style="color: green;">@iRank</span><span
style="color: grey;">-</span><span
style="color: maroon; font-weight: bold;">1</span>)), dtDate)\
    <span style="color: blue;">FROM</span>    <span
style="color: green;">@tmp</span>\
    <span style="color: blue;">WHERE</span>    <span
style="color: magenta;">DATEADD</span>(<span
style="color: magenta;">DAY</span>, <span
style="color: magenta;">POWER</span>(<span
style="color: maroon; font-weight: bold;">2</span>, <span
style="color: green;">@iRank</span><span
style="color: grey;">-</span><span
style="color: maroon; font-weight: bold;">1</span>), dtDate) <span
style="color: grey;">&lt;=</span> <span
style="color: green;">@dtEnd</span>\
   \
    <span style="color: blue;">SET</span> <span
style="color: green;">@iRank</span> <span
style="color: grey;">=</span> <span
style="color: green;">@iRank</span> <span
style="color: grey;">+</span> <span
style="color: maroon; font-weight: bold;">1</span>\
<span style="color: blue;">END</span>\
<span style="color: teal;">/\*</span><span style="color: teal;">\
此处代码功能说明：\
    根据时间序列表，生成动态SQL\
注：\
    之所以将动态sql分到两个变量里，主要是尽量避免8000个字符的限制\
</span><span style="color: teal;">\*/</span>\
<span style="color: blue;">DECLARE</span> <span
style="color: green;">@sql\_a</span> <span
style="color: blue;">VARCHAR</span>(<span
style="color: maroon; font-weight: bold;">8000</span>)\
<span style="color: blue;">SET</span> <span
style="color: green;">@sql\_a</span> <span
style="color: grey;">=</span> <span style="color: red;">'</span><span
style="color: red;">select vName</span><span
style="color: red;">'</span>\
<span style="color: blue;">SELECT</span>  <span
style="color: green;">@sql\_a</span> <span
style="color: grey;">=</span> <span
style="color: green;">@sql\_a</span>\
                <span style="color: grey;">+</span> <span
style="color: red;">'</span><span
style="color: red;">, sum(case dtDate when </span><span
style="color: red;">'''</span> <span style="color: grey;">+</span> <span
style="color: magenta;">CONVERT</span>(<span
style="color: blue;">NVARCHAR</span>(<span
style="color: maroon; font-weight: bold;">10</span>), dtDate, <span
style="color: maroon; font-weight: bold;">120</span>)\
                <span style="color: grey;">+</span> <span
style="color: red;">'''</span><span
style="color: red;"> then iNum else 0 end) \[</span><span
style="color: red;">'</span> <span style="color: grey;">+</span> <span
style="color: magenta;">CONVERT</span>(<span
style="color: blue;">NVARCHAR</span>(<span
style="color: maroon; font-weight: bold;">10</span>), dtDate, <span
style="color: maroon; font-weight: bold;">120</span>) <span
style="color: grey;">+</span> <span style="color: red;">'</span><span
style="color: red;">\]</span><span style="color: red;">'</span>\
<span style="color: blue;">FROM</span>    <span
style="color: green;">@tmp</span> <span
style="color: blue;">AS</span> a<span
style="color: blue;">SET</span> <span
style="color: green;">@sql\_a</span> <span
style="color: grey;">=</span> <span
style="color: green;">@sql\_a</span> <span
style="color: grey;">+</span> <span style="color: red;">'</span><span
style="color: red;">, sum(iNum) as iTotal from tb group by vName</span><span
style="color: red;">'</span>\
<span style="color: teal;">--</span><span
style="color: teal;">EXEC(@sql\_a)</span><span style="color: teal;">\
</span>\
<span style="color: blue;">DECLARE</span> <span
style="color: green;">@sql\_b</span> <span
style="color: blue;">VARCHAR</span>(<span
style="color: maroon; font-weight: bold;">8000</span>)\
<span style="color: blue;">SET</span> <span
style="color: green;">@sql\_b</span> <span
style="color: grey;">=</span> <span style="color: red;">'</span><span
style="color: red;">select </span><span
style="color: red;">''</span><span style="color: red;">total</span><span
style="color: red;">'''</span>\
<span style="color: blue;">SELECT</span>    <span
style="color: green;">@sql\_b</span> <span
style="color: grey;">=</span> <span
style="color: green;">@sql\_b</span> <span
style="color: grey;">+</span> <span style="color: red;">'</span><span
style="color: red;">, isnull((select sum(iNum) from tb where dtDate=</span><span
style="color: red;">'''</span> <span style="color: grey;">+</span> <span
style="color: magenta;">CONVERT</span>(<span
style="color: blue;">NVARCHAR</span>(<span
style="color: maroon; font-weight: bold;">10</span>), dtDate, <span
style="color: maroon; font-weight: bold;">120</span>) <span
style="color: grey;">+</span> <span style="color: red;">'''</span><span
style="color: red;">), 0)</span><span style="color: red;">'</span>\
<span style="color: blue;">FROM</span>    <span
style="color: green;">@tmp</span>\
<span style="color: blue;">ORDER</span> <span
style="color: blue;">BY</span> dtDate\
<span style="color: blue;">SET</span> <span
style="color: green;">@sql\_b</span> <span
style="color: grey;">=</span> <span
style="color: green;">@sql\_b</span> <span
style="color: grey;">+</span> <span style="color: red;">'</span><span
style="color: red;">, (select sum(iNum) from tb)</span><span
style="color: red;">'</span>\
<span style="color: teal;">--</span><span
style="color: teal;">EXEC(@sql\_b)</span><span style="color: teal;">\
</span><span style="color: blue;">EXEC</span>(<span
style="color: red;">'</span><span
style="color: red;">select \* from (</span><span
style="color: red;">'</span> <span style="color: grey;">+</span> <span
style="color: green;">@sql\_a</span> <span
style="color: grey;">+</span> <span style="color: red;">'</span><span
style="color: red;"> union </span><span
style="color: red;">'</span> <span style="color: grey;">+</span> <span
style="color: green;">@sql\_b</span> <span
style="color: grey;">+</span> <span style="color: red;">'</span><span
style="color: red;">) as a order by a.iTotal</span><span
style="color: red;">'</span>)\
<span style="color: blue;">GO</span>\

</div>

</div>

\
![](http://www.cnblogs.com/zhaoguan_wang/aggbug/1656069.html?type=1){width="1"
height="1"}\
评论:
0　[查看评论](http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html#pagedcomment)　[发表评论](http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html#commentform)

</div>

</div>

</div>

</div>

</div>

</div>

</div>

---
layout: post
title: "搭建OpenVpn服务端与客户端的记录"
date: '2012-07-03T22:36:00.000+08:00'
author: Wenh Q
tags:
- linux
modified_time: '2013-09-30T14:17:20.295+08:00'
blogger_id: tag:blogger.com,1999:blog-4961947611491238191.post-2702230920304643258
blogger_orig_url: http://binaryware.blogspot.com/2012/07/openvpn.html
---

<h2 style="text-align: center;"></h2><h2 style="text-align: left;">   更新记录</h2><div style="text-align: left;">2012-07-03 创建<br /><a name='more'></a></div><h2 style="text-align: left;">   一、环境</h2><div style="text-align: left;">服务端：操作系统CentOS release 5.5 32bit，OpenVpn版本OpenVPN 2.1.3</div><div style="text-align: left;">客户端：操作系统 Ubuntu 12.04 LTS 32bit，OpenVpn版本OpenVPN 2.2.1</div><div style="text-align: left;"><br /></div><h2 style="text-align: left;">   二、准备</h2><div style="text-align: left;">系统内核</div><div style="text-align: left;">TUN/TAP支持</div><div style="text-align: left;">支持包</div><div style="text-align: left;">yum install openssl-devel</div><div style="text-align: left;">http://www.oberhumer.com/opensource/lzo/ 下载LZO</div><div style="text-align: left;">./configure&amp;&amp;make&amp;&amp;make install<br />http://openvpn.net/release/ 下载openvpn<br />./configure&amp;&amp;make&amp;&amp;make install </div><h2 style="text-align: left;">   三、服务端配置</h2><div style="text-align: left;">认证中最重要的是服务器和客户端的SSL证书管理，如果管理员之前没有SSL证书发布机制，那么可以使用OpenVPN附带的一组工具来完成所有的工作。</div><h3> 1.修改vars文件变量</h3>[root@localhost openvpn-2.1.3]# cd easy-rsa/2.0/<br />[root@localhost 2.0]# grep -v "#" vars<br /><blockquote class="tr_bq">export EASY_RSA="`pwd`"</blockquote><blockquote><br />export OPENSSL="openssl"<br />export PKCS11TOOL="pkcs11-tool"<br />export GREP="grep"<br /><br />export KEY_CONFIG="$EASY_RSA/openssl.cnf"<br />export KEY_DIR="$EASY_RSA/keys"<br /><br />echo NOTE: If you run ./clean-all, I will be doing a rm -rf on $KEY_DIR<br /><br />export PKCS11_MODULE_PATH="dummy"<br />export PKCS11_PIN="dummy"<br /><br />export KEY_SIZE=1024<br />export CA_EXPIRE=3650<br />export KEY_EXPIRE=3650<br /><br />export KEY_COUNTRY="CN"<br />export KEY_PROVINCE="SH"<br />export KEY_CITY="PD"<br />export KEY_ORG="Earth"<br />export KEY_EMAIL="******@**.com"</blockquote>[root@localhost 2.0]# source vars<br /><blockquote class="tr_bq">NOTE: when you run ./clean-all, I will be doing a rm -rf on /usr/src/openvpn-2.0.9/easy-rsa/keys&nbsp;&nbsp;</blockquote>提示可使用./clean-all清除所有包括CA在内的所有证书<br /><h3> 2.clean-all</h3>使用clean-all脚本清除包括CA在内的所有证书，再创建CA证书。<br />[root@localhost 2.0]# ./clean-all&nbsp;&nbsp; #先清除证书，再创建证书<br />[root@localhost 2.0]# ./build-ca&nbsp; #创建CA证书<br /><blockquote class="tr_bq">Generating a 1024 bit RSA private key<br />..........++++++<br />................++++++<br />writing new private key to 'ca.key'<br />-----<br />You are about to be asked to enter information that will be incorporated<br />into your certificate request.<br />What you are about to enter is what is called a Distinguished Name or a DN.<br />There are quite a few fields but you can leave some blank<br />For some fields there will be a default value,<br />If you enter '.', the field will be left blank.<br />-----<br />Country Name (2 letter code) [CN]:<br />State or Province Name (full name) [SH]:<br />Locality Name (eg, city) []:<br />Organization Name (eg, company) [:<br />Organizational Unit Name (eg, section) []:<br />Common Name (eg, your name or your server's hostname) []:&nbsp;&nbsp; #服务器主机名<br />Email Address [******@**.com]:&nbsp;</blockquote><h3> 3.创建服务器密钥</h3>[root@localhost 2.0]# ./build-key-server server<br /><blockquote class="tr_bq">Generating a 1024 bit RSA private key<br />............................................++++++<br />....++++++<br />writing new private key to 'server.key'<br />-----<br />You are about to be asked to enter information that will be incorporated<br />into your certificate request.<br />What you are about to enter is what is called a Distinguished Name or a DN.<br />There are quite a few fields but you can leave some blank<br />For some fields there will be a default value,<br />If you enter '.', the field will be left blank.<br />-----<br />Country Name (2 letter code) [CN]:<br />State or Province Name (full name) [SH]:<br />Locality Name (eg, city) [SH]:<br />Organization Name (eg, company) []:<br />Organizational Unit Name (eg, section) []:<br />Common Name (eg, your name or your server's hostname) [Server]:&nbsp; #服务器主机名<br />Email Address [tghfly222@126.com]:<br />Please enter the following 'extra' attributes<br />to be sent with your certificate request<br />A challenge password []:<br />An optional company name []:<br />Check that the request matches the signature<br />Signature ok<br />...<br />Sign the certificate? [y/n]:y<br />1 out of 1 certificate requests certified, commit? [y/n]y<br />Write out database with 1 new entries<br />Data Base Updated</blockquote><h3> 4.创建客户端密钥</h3>[root@localhost 2.0]# ./build-key client<br /><blockquote class="tr_bq">Generating a 1024 bit RSA private key<br />.....++++++<br />.......................++++++<br />writing new private key to 'client.key'<br />-----<br />You are about to be asked to enter information that will be incorporated<br />into your certificate request.<br />What you are about to enter is what is called a Distinguished Name or a DN.<br />There are quite a few fields but you can leave some blank<br />For some fields there will be a default value,<br />If you enter '.', the field will be left blank.<br />-----<br />...<br />Common Name (eg, your name or your server's hostname) []:client&nbsp; #不同客户端，命名绝不能一样<br />Email Address [******@**.com]:<br />Please enter the following 'extra' attributes<br />to be sent with your certificate request<br />A challenge password []:<br />An optional company name []:<br />...<br />Certificate is to be certified until Jul 16 05:52:27 2021 GMT (3650 days)<br />Sign the certificate? [y/n]:y<br />1 out of 1 certificate requests certified, commit? [y/n]y<br />Write out database with 1 new entries<br />Data Base Updated</blockquote><h3> 5.build-dh</h3>创建dhDiffie-Hellman密钥算法文件<br />[root@localhost 2.0]# ./build-dh<br /><blockquote class="tr_bq">Generating DH parameters, 1024 bit long safe prime, generator 2<br />This is going to take a long time<br />...+.......+.....+........................+......................+.....+........................</blockquote><blockquote>...+..........+.......+.................................................+.....................+.........<br />...+..............................................+.......................................................</blockquote><blockquote>...+..............................+...........................+..+.....+......++*++*++*</blockquote><h3> 6.生成&nbsp; tls-auth 密钥</h3>tls-auth密钥可以为点对点的VPN连接提供了进一步的安全验证，如果选择使用这一方式，服务器端和客户端都必须拥有该密钥文件。<br />[root@localhost 2.0]# openvpn --genkey --secret keys/ta.key<br /><h3> 7.配置目录/etc/openvpn，复制key</h3>OpenVPN的配置目录为/etc/openvpn，把服务器配置文件定义为/etc/openvpn/server.conf<br />OpenVPN是一个SSL VPN实现。<br />[root@localhost 2.0]# mkdir -p /etc/openvpn<br />[root@localhost 2.0]# cp -p sample-config-files/server.conf /etc/openvpn/&nbsp;&nbsp;  #将样本配置文件复制到/etc/openvpn/，后面再做修改<br />[root@localhost 2.0]# cp -rp keys/ /etc/openvpn/&nbsp;&nbsp;&nbsp; #将证书文件复制到/etc/openvpn/ <br /><h3> 8.修改server.conf</h3>[root@dic172 openvpn]# grep -v "#" server.conf<br /><blockquote class="tr_bq">local 192.168.161.172&nbsp;&nbsp;&nbsp;&nbsp; #服务器所使用的IP</blockquote><blockquote><br />port 1194&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #使用1194端口<br />proto tcp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #使用TCP协议<br />dev tun&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; #使用tun设备<br />ca keys/ca.crt&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #指定CA证书文件路径<br />cert keys/server.crt<br />dh keys/dh1024.pem<br />server 10.8.0.0 255.255.255.0&nbsp;&nbsp;&nbsp; #VPN客户端拨入后，所获得的IP地址池<br />ifconfig-pool-persist ipp.txt<br />push "redirect-gateway def1 bypass-dhcp"<br />push "dhcp-option DNS 8.8.8.8"&nbsp;&nbsp; #客户端所获得的DNS<br />push "dhcp-option DNS 8.8.4.4"&nbsp;&nbsp; #客户端所获得的备用DNS</blockquote><blockquote>;tls-auth /etc/openvpn/keys/ta.key 0<br />keepalive 10 120<br />comp-lzo<br />max-clients 10<br />persist-key<br />persist-tun<br />status openvpn-status.log<br />verb 6</blockquote><h3> 9.网络配置 </h3>开启IP转发功能<br />[root@dic172 openvpn]# vi /etc/sysctl.conf<br /><blockquote class="tr_bq">net.ipv4.ip_forward = 1</blockquote><br />[root@dic172 openvpn]# sysctl -p<br />或<br />[root@dic172 openvpn]# echo "1" &gt; /proc/sys/net/ipv4/ip_forward<br />开1149端口<br />[root@dic172 openvpn]# IPTABLES -A INPUT -p udp --dport 1194 -j ACCEPT<br />还有一个不懂的 <br />[root@dic172 openvpn]# iptables -t nat -A POSTROUTING -s 10.8.0.0/24  -o venet0 -j MASQUERADE<br /><h3> 10.服务启动与维护</h3>[root@localhost 2.0]# cp -p sample-scripts/openvpn.init /etc/init.d/openvpn <br />[root@localhost 2.0]# chkconfig --add openvpn<br />[root@localhost 2.0]# service openvpn status&nbsp; #查看服务状态<br /><blockquote class="tr_bq">openvpn: service not started</blockquote>[root@localhost 2.0]# chkconfig --level 235 openvpn on<br />[root@localhost 2.0]# chkconfig --list openvpn<br />openvpn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0:off&nbsp;&nbsp; 1:off&nbsp;&nbsp; 2:on&nbsp;&nbsp;&nbsp; 3:on&nbsp;&nbsp;&nbsp; 4:on&nbsp;&nbsp;&nbsp; 5:on&nbsp;&nbsp;&nbsp; 6:off <br />启动openvpn<br />[root@dic172 openvpn]# service openvpn start<br /><blockquote class="tr_bq">Starting openvpn: [&nbsp; OK&nbsp; ]</blockquote>[root@dic172 openvpn]# netstat -anp |grep :1194<br /><blockquote class="tr_bq">udp&nbsp; 0&nbsp; 0 192.168.161.172:1194&nbsp; 0.0.0.0:*&nbsp; 25162/openvpn</blockquote><h2 style="text-align: left;">   四、客户端配置</h2><div style="text-align: left;">安装见参考文献。</div><div style="text-align: left;">client.cnf配置文件如下：</div><blockquote class="tr_bq">client<br />dev tun<br />proto tcp<br />remote xxxxx.xxx.xxxx 1194<br />resolv-retry infinite<br />nobind<br />persist-key<br />persist-tun<br />ca /etc/openvpn/keys/ca.crt<br />cert /etc/openvpn/keys/xxxxxx.crt<br />key /etc/openvpn/keys/xxxxxxx.key<br />tls-auth /etc/openvpn/keys/ta.key 1<br />comp-lzo<br />verb 6</blockquote>启动命令：<br />openvpn --config /etc/openvpn/client.cnf &amp;<br /><h2 style="text-align: left;"> 五、常见错误</h2><div style="text-align: left;">见参考文献4. </div><h2 style="text-align: left;"> 六、参考文献</h2><ol><li>《<a href="http://linux.chinaitlab.com/administer/859678.html">Linux为企业搭建稳固的SSL VPN服务</a>》 </li><li>《<a href="http://network.51cto.com/art/201012/236266.htm">实践出真知 布署openvpn环境应注意的事</a>》</li><li>《<a href="http://www.vpser.net/build/ramhost-vps-install-ssh-openvpn.html">RAMHOST的VPS小攻略之SSH和OpenVPN安装配置</a>》&nbsp;</li><li>《<a href="http://www.f15ijp.com/2010/08/openvpn-tls-error-reading-acknowledgement-record-from-packet/">OpenVPN: TLS Error: reading acknowledgement record from packet</a>》 </li><li>http://www.f15ijp.com/tag/openvpn/</li></ol><div style="text-align: left;"><br /></div>
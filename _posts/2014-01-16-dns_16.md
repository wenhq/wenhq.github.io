--- layout: post title: DNS 隧道 date: '2014-01-16T16:04:00.002+08:00'
author: Wenh Q tags: modified\_time: '2014-01-16T16:04:52.222+08:00'
blogger\_id:
tag:blogger.com,1999:blog-4961947611491238191.post-7864110756717596524
blogger\_orig\_url: http://binaryware.blogspot.com/2014/01/dns\_16.html
--- [DNS 隧道](http://blog.codingnow.com/2011/06/dns_tunnel.html)  于
11-6-27 通过 [云风的 BLOG](http://blog.codingnow.com/)\
\
今天在 greader 上看到这么一篇，[用 DNS
隧道实现免费上网](http://blog.creke.net/747.html)。我的思绪猛然回到去年去[新西兰度假](http://blog.codingnow.com/2010/09/nz.html)的日子。\
\
有那么几天，我们在惠灵顿的海边山顶租了个屋子，一切都很舒服，但是不能上网。甚至于附近连
wifi 信号都收不到，想"借用"一下别人的 wifi
热点都不成。我顶着海边的狂风在院子里竖起天线，捕捉着周围微弱的信号，最终未果。然后转战屋里的有线电视。我发现和国内的有线电视一样，机顶盒是接有网线的。也就是说，物理上，存在一条链路接入了互联网。但是我插上电脑后，发现
ip 包根本发不出去。不过，好似有个 DNS 服务是可以用的。\
\
当时也没多想，只是觉得有办法可以利用一下。不过隔天就搬走了，没有深入下去。今天回味一下，感觉的确可以利用
DNS
服务和外部建立连接。当然，一开始就需要在外界把接应的程序程序搭建好。\
\
原理很简单，你在做 DNS 查询的时候，如果查的域名在 DNS 服务器本机的 cache
中没有，它就会去互联网上查询，最终把结果返回给你。如果你在互联网上有台定制的服务器。只要依靠
DNS 的这层约定，就可以交换数据包了。从 DNS
协议上看，你是在一次次的查询某个特定域名，并得到解析结果。但实际上，你在和外部通讯。你没有直接连到局域网外的机器，因为网关不会转发你的
IP 包出去。但局域网上的 DNS 服务器帮你做了中转。这就是 DNS Tunnel 了。\
\
我觉得有趣，就按文章所述做了试验。\
\
这需要一个自己的域名，一台运行在互联网上的机器可以自由安装软件。这些都有。那个假的
DNS 是由 OzymanDNS 提供的。不过今天我搜到的 OzymanDNS
网站上已经没有了下载包。好在 google 很强大，这个 2004 年编写的小 perl
程序，并不难找到。\
\
不过我反复试验也没有成功，按文章所述的，利用 ssh 在本机上的 proxycommand
我怎么都无法通过 dnstunnel
连上主机。估计是我哪里配置的不对吧。不过接下来 google
到了更好的选择。那就是 [iodine](http://dev.kryo.se/iodine/)
这个小玩意。非常简单的就装好了。第一次运行发现找不到 tun
设备。看来需要手工建一个。在 linux 上可以自己来： mkdir /dev/net ; mknod
/dev/net/tun c 10 200 这样即可。\
\
windows 版麻烦一些，需要装软件。安装个 openvpn 包里的 TAP driver
就行了。\
\
然后利用 iodine 可以利用 dns tunnel 建立起虚拟网。接下来可以方便的用 ssh
-D 建起 socks5 了。不过我觉得这个都是多余的。为了节约 dns tunnel
上的带宽，我直接建了个 socks5 服务器。就是用的我[前段写的一篇
blog](http://blog.codingnow.com/2011/05/xtunnel.html) 中提到的 ssocks
。同样需要修改一下，把监听端口绑定在 10.0.0.1 上。\
\
最后，居然没遇到什么麻烦就接通了。我想我所在网络出口上的 dns
服务器肯定觉得很疼。这真是一个超级淡疼的 tunnel
方案啊。嗯，可以留作日后翻墙的备用方案，以备不时之需。\
\
ps. 好想知道到处都有的诸如 CMCC 的 wifi
热点能不能用。下次到商业区别忘记试试看。

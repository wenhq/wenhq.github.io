---
layout: post
title: "多种sql技术的综合应用（行转列、定制、批量数据产生）"
date: '2014-01-06T17:23:00.002+08:00'
author: Wenh Q
tags: 
modified_time: '2014-01-06T17:23:22.126+08:00'
blogger_id: tag:blogger.com,1999:blog-4961947611491238191.post-622168169161913767
blogger_orig_url: http://binaryware.blogspot.com/2014/01/sql.html
---

<div dir="ltr"><a href="http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html" style="font-family: sans-serif;" target="_blank">多种sql技术的综合应用（行转列、定制、批量数据产生）</a>&nbsp;&nbsp;<span style="font-family: sans-serif;">于 10-1-25 通过 </span><a href="http://www.cnblogs.com/" style="font-family: sans-serif;" target="_blank">博客园-首页原创精华区</a><span style="font-family: sans-serif;"> 作者：王召冠</span><br /><div class="gmail_quote"><div class="HOEnZb"><div class="h5"><div dir="ltr"><div class="gmail_quote"><div style="font-family: sans-serif; margin: 0px 10px; overflow: auto; width: 100%;"><br />阅读: 692 评论: 0 作者: <a href="http://www.cnblogs.com/zhaoguan_wang/" target="_blank">王召冠</a> 发表于 2010-01-25 20:34 <a href="http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html" target="_blank">原文链接</a><br /><div><div><span style="color: teal;">/*</span><span style="color: teal;"><br />功能：按报表格式显示（行转列、定制、批量数据产生）<br />作者：王召冠<br />时间：2010-01-25&nbsp;20:10<br />说明：此例子也是多种sql技术的综合应用<br /><br />问题：假设有张考勤表(tb)如下:<br />姓名&nbsp;&nbsp;&nbsp;&nbsp;　考勤日期&nbsp;&nbsp;&nbsp;&nbsp;　　考勤次数<br />张三&nbsp;&nbsp;&nbsp;&nbsp;2010-01-01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<br />      张三&nbsp;&nbsp;&nbsp;&nbsp;2010-01-02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3<br />张三&nbsp;&nbsp;&nbsp;&nbsp;2010-01-03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br />张三&nbsp;&nbsp;&nbsp;&nbsp;2010-01-01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br />李四&nbsp;&nbsp;&nbsp;&nbsp;2010-01-02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<br />李四&nbsp;&nbsp;&nbsp;&nbsp;2010-01-03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<br /><br />想变成(得到如下结果)：按指定时间段显示考勤报表<br />姓名&nbsp; 2010-01-01&nbsp;2010-01-02&nbsp;2010-01-03&nbsp;2010-01-04&nbsp; ...&nbsp;汇总&nbsp;&nbsp;&nbsp;&nbsp;<br />      ----&nbsp;----------&nbsp;----------&nbsp;----------&nbsp;----------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;----<br />李四&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4<br />张三&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7<br />汇总&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11<br />      ----------------------------------------------------------</span><span style="color: teal;">*/</span><br /><span style="color: blue;">CREATE</span>&nbsp;<span style="color: blue;">TABLE</span>&nbsp;tb(vName&nbsp;<span style="color: blue;">NVARCHAR</span>(<span style="color: maroon; font-weight: bold;">10</span>),&nbsp;dtDate&nbsp;<span style="color: blue;">DATETIME</span>,&nbsp;iNum&nbsp;<span style="color: blue;">INT</span>)<br />      <span style="color: blue;">GO</span><br /><span style="color: blue;">INSERT</span>&nbsp;&nbsp;<span style="color: blue;">INTO</span>&nbsp;tb&nbsp;<span style="color: blue;">VALUES</span>&nbsp;&nbsp;(&nbsp;<span style="color: red;">'</span><span style="color: red;">张三</span><span style="color: red;">'</span>,&nbsp;<span style="color: red;">'</span><span style="color: red;">2010-01-01</span><span style="color: red;">'</span>,&nbsp;<span style="color: maroon; font-weight: bold;">2</span>&nbsp;)<br />      <span style="color: blue;">INSERT</span>&nbsp;&nbsp;<span style="color: blue;">INTO</span>&nbsp;tb<span style="color: blue;">VALUES</span>&nbsp;&nbsp;(&nbsp;<span style="color: red;">'</span><span style="color: red;">张三</span><span style="color: red;">'</span>,&nbsp;<span style="color: red;">'</span><span style="color: red;">2010-01-02</span><span style="color: red;">'</span>,&nbsp;<span style="color: maroon; font-weight: bold;">3</span>&nbsp;)<br />      <span style="color: blue;">INSERT</span>&nbsp;&nbsp;<span style="color: blue;">INTO</span>&nbsp;tb<span style="color: blue;">VALUES</span>&nbsp;&nbsp;(&nbsp;<span style="color: red;">'</span><span style="color: red;">张三</span><span style="color: red;">'</span>,&nbsp;<span style="color: red;">'</span><span style="color: red;">2010-01-03</span><span style="color: red;">'</span>,&nbsp;<span style="color: maroon; font-weight: bold;">1</span>&nbsp;)<br />      <span style="color: blue;">INSERT</span>&nbsp;&nbsp;<span style="color: blue;">INTO</span>&nbsp;tb<span style="color: blue;">VALUES</span>&nbsp;&nbsp;(&nbsp;<span style="color: red;">'</span><span style="color: red;">张三</span><span style="color: red;">'</span>,&nbsp;<span style="color: red;">'</span><span style="color: red;">2010-01-01</span><span style="color: red;">'</span>,&nbsp;<span style="color: maroon; font-weight: bold;">1</span>&nbsp;)<br />      <span style="color: blue;">INSERT</span>&nbsp;&nbsp;<span style="color: blue;">INTO</span>&nbsp;tb<span style="color: blue;">VALUES</span>&nbsp;&nbsp;(&nbsp;<span style="color: red;">'</span><span style="color: red;">李四</span><span style="color: red;">'</span>,&nbsp;<span style="color: red;">'</span><span style="color: red;">2010-01-02</span><span style="color: red;">'</span>,&nbsp;<span style="color: maroon; font-weight: bold;">2</span>&nbsp;)<br />      <span style="color: blue;">INSERT</span>&nbsp;&nbsp;<span style="color: blue;">INTO</span>&nbsp;tb<span style="color: blue;">VALUES</span>&nbsp;&nbsp;(&nbsp;<span style="color: red;">'</span><span style="color: red;">李四</span><span style="color: red;">'</span>,&nbsp;<span style="color: red;">'</span><span style="color: red;">2010-01-03</span><span style="color: red;">'</span>,&nbsp;<span style="color: maroon; font-weight: bold;">2</span>&nbsp;)<br />      <span style="color: blue;">GO</span><br /><span style="color: teal;">--</span><span style="color: teal;">SELECT&nbsp;&nbsp;&nbsp;&nbsp;*</span><span style="color: teal;"><br />--</span><span style="color: teal;">FROM&nbsp;&nbsp;&nbsp;&nbsp;tb</span><span style="color: teal;"><br />      </span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: teal;">--</span><span style="color: teal;">SQL&nbsp;SERVER&nbsp;动态SQL</span><span style="color: teal;"><br /></span><span style="color: teal;">DECLARE&nbsp;@dtBegin&nbsp;DATETIME,&nbsp;@dtEnd&nbsp;DATETIME</span><span style="color: teal;"><br />      </span><span style="color: teal;">SELECT&nbsp;&nbsp;&nbsp;&nbsp;@dtBegin&nbsp;=&nbsp;'2010-01-01',&nbsp;@dtEnd&nbsp;=&nbsp;'2010-01-31'</span><span style="color: teal;"><br /></span><br /><span style="color: blue;">SET</span>&nbsp;NOCOUNT&nbsp;<span style="color: blue;">ON</span><br />      <span style="color: teal;">/*</span><span style="color: teal;"><br />此处代码功能说明：<br />&nbsp;&nbsp;&nbsp;&nbsp;根据指定的时间段，快速生成一个不间断的时间序列表<br />具体实现特性说明：<br />&nbsp;&nbsp;&nbsp;&nbsp;每循环一次生成2的n次方条记录，减少循环次数。<br />注：<br />&nbsp;&nbsp;&nbsp;&nbsp;从实际应用上来说，在此处没有太明显的效果和意义；仅仅体现一种优化算法而已。<br />    </span><span style="color: teal;">*/</span><br />  <span style="color: blue;">DECLARE</span>&nbsp;<span style="color: green;">@iRank</span>&nbsp;<span style="color: blue;">INT</span>&nbsp;<span style="color: blue;">SET</span>&nbsp;<span style="color: green;">@iRank</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: maroon; font-weight: bold;">1</span><br />      <span style="color: blue;">DECLARE</span>&nbsp;<span style="color: green;">@tmp</span>&nbsp;<span style="color: blue;">TABLE</span>(dtDate&nbsp;<span style="color: blue;">DATETIME</span>)<br />      <span style="color: blue;">INSERT</span>&nbsp;<span style="color: blue;">INTO</span>&nbsp;<span style="color: green;">@tmp</span>&nbsp;(&nbsp;dtDate&nbsp;)&nbsp;<span style="color: blue;">VALUES</span>&nbsp;(&nbsp;<span style="color: green;">@dtBegin</span>&nbsp;)<br />      <span style="color: blue;">WHILE</span>&nbsp;<span style="color: magenta;">DATEADD</span>(<span style="color: magenta;">DAY</span>,&nbsp;<span style="color: magenta;">POWER</span>(<span style="color: maroon; font-weight: bold;">2</span>,&nbsp;(<span style="color: green;">@iRank</span><span style="color: grey;">-</span><span style="color: maroon; font-weight: bold;">1</span>)),&nbsp;<span style="color: green;">@dtBegin</span>)&nbsp;<span style="color: grey;">&lt;=</span>&nbsp;<span style="color: green;">@dtEnd</span><br />      <span style="color: blue;">BEGIN</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">INSERT</span>&nbsp;<span style="color: blue;">INTO</span>&nbsp;<span style="color: green;">@tmp</span>&nbsp;(&nbsp;dtDate&nbsp;)<br />      &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">SELECT</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: magenta;">DATEADD</span>(<span style="color: magenta;">DAY</span>,&nbsp;<span style="color: magenta;">POWER</span>(<span style="color: maroon; font-weight: bold;">2</span>,&nbsp;(<span style="color: green;">@iRank</span><span style="color: grey;">-</span><span style="color: maroon; font-weight: bold;">1</span>)),&nbsp;dtDate)<br />      &nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">@tmp</span><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">WHERE</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: magenta;">DATEADD</span>(<span style="color: magenta;">DAY</span>,&nbsp;<span style="color: magenta;">POWER</span>(<span style="color: maroon; font-weight: bold;">2</span>,&nbsp;<span style="color: green;">@iRank</span><span style="color: grey;">-</span><span style="color: maroon; font-weight: bold;">1</span>),&nbsp;dtDate)&nbsp;<span style="color: grey;">&lt;=</span>&nbsp;<span style="color: green;">@dtEnd</span><br />      &nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: blue;">SET</span>&nbsp;<span style="color: green;">@iRank</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: green;">@iRank</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: maroon; font-weight: bold;">1</span><br />      <span style="color: blue;">END</span><br /><span style="color: teal;">/*</span><span style="color: teal;"><br />此处代码功能说明：<br />&nbsp;&nbsp;&nbsp;&nbsp;根据时间序列表，生成动态SQL<br />注：<br />&nbsp;&nbsp;&nbsp;&nbsp;之所以将动态sql分到两个变量里，主要是尽量避免8000个字符的限制<br />  </span><span style="color: teal;">*/</span><br /><span style="color: blue;">DECLARE</span>&nbsp;<span style="color: green;">@sql_a</span>&nbsp;<span style="color: blue;">VARCHAR</span>(<span style="color: maroon; font-weight: bold;">8000</span>)<br />      <span style="color: blue;">SET</span>&nbsp;<span style="color: green;">@sql_a</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">select&nbsp;vName</span><span style="color: red;">'</span><br />      <span style="color: blue;">SELECT</span>&nbsp;&nbsp;<span style="color: green;">@sql_a</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: green;">@sql_a</span><br />      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">,&nbsp;sum(case&nbsp;dtDate&nbsp;when&nbsp;</span><span style="color: red;">'''</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: magenta;">CONVERT</span>(<span style="color: blue;">NVARCHAR</span>(<span style="color: maroon; font-weight: bold;">10</span>),&nbsp;dtDate,&nbsp;<span style="color: maroon; font-weight: bold;">120</span>)<br />      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'''</span><span style="color: red;">&nbsp;then&nbsp;iNum&nbsp;else&nbsp;0&nbsp;end)&nbsp;[</span><span style="color: red;">'</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: magenta;">CONVERT</span>(<span style="color: blue;">NVARCHAR</span>(<span style="color: maroon; font-weight: bold;">10</span>),&nbsp;dtDate,&nbsp;<span style="color: maroon; font-weight: bold;">120</span>)&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">]</span><span style="color: red;">'</span><br />      <span style="color: blue;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">@tmp</span>&nbsp;<span style="color: blue;">AS</span>&nbsp;a<span style="color: blue;">SET</span>&nbsp;<span style="color: green;">@sql_a</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: green;">@sql_a</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">,&nbsp;sum(iNum)&nbsp;as&nbsp;iTotal&nbsp;from&nbsp;tb&nbsp;group&nbsp;by&nbsp;vName</span><span style="color: red;">'</span><br />      <span style="color: teal;">--</span><span style="color: teal;">EXEC(@sql_a)</span><span style="color: teal;"><br /></span><br /><span style="color: blue;">DECLARE</span>&nbsp;<span style="color: green;">@sql_b</span>&nbsp;<span style="color: blue;">VARCHAR</span>(<span style="color: maroon; font-weight: bold;">8000</span>)<br />      <span style="color: blue;">SET</span>&nbsp;<span style="color: green;">@sql_b</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">select&nbsp;</span><span style="color: red;">''</span><span style="color: red;">total</span><span style="color: red;">'''</span><br />      <span style="color: blue;">SELECT</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">@sql_b</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: green;">@sql_b</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">,&nbsp;isnull((select&nbsp;sum(iNum)&nbsp;from&nbsp;tb&nbsp;where&nbsp;dtDate=</span><span style="color: red;">'''</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: magenta;">CONVERT</span>(<span style="color: blue;">NVARCHAR</span>(<span style="color: maroon; font-weight: bold;">10</span>),&nbsp;dtDate,&nbsp;<span style="color: maroon; font-weight: bold;">120</span>)&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'''</span><span style="color: red;">),&nbsp;0)</span><span style="color: red;">'</span><br />      <span style="color: blue;">FROM</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: green;">@tmp</span><br /><span style="color: blue;">ORDER</span>&nbsp;<span style="color: blue;">BY</span>&nbsp;dtDate<br />      <span style="color: blue;">SET</span>&nbsp;<span style="color: green;">@sql_b</span>&nbsp;<span style="color: grey;">=</span>&nbsp;<span style="color: green;">@sql_b</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">,&nbsp;(select&nbsp;sum(iNum)&nbsp;from&nbsp;tb)</span><span style="color: red;">'</span><br />      <span style="color: teal;">--</span><span style="color: teal;">EXEC(@sql_b)</span><span style="color: teal;"><br /></span><span style="color: blue;">EXEC</span>(<span style="color: red;">'</span><span style="color: red;">select&nbsp;*&nbsp;from&nbsp;(</span><span style="color: red;">'</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: green;">@sql_a</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">&nbsp;union&nbsp;</span><span style="color: red;">'</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: green;">@sql_b</span>&nbsp;<span style="color: grey;">+</span>&nbsp;<span style="color: red;">'</span><span style="color: red;">)&nbsp;as&nbsp;a&nbsp;order&nbsp;by&nbsp;a.iTotal</span><span style="color: red;">'</span>)<br />      <span style="color: blue;">GO</span><br /></div></div><br /><img alt="" src="http://www.cnblogs.com/zhaoguan_wang/aggbug/1656069.html?type=1" height="1" width="1" /><br />评论: 0　<a href="http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html#pagedcomment" target="_blank">查看评论</a>　<a href="http://www.cnblogs.com/zhaoguan_wang/archive/2010/01/25/1656069.html#commentform" target="_blank">发表评论</a></div></div></div></div></div></div></div>